<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDL Litigation Intelligence Platform | 49 Cases | 330K+ MDRs</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b2d;
            --bg-tertiary: #1e2738;
            --border-color: #2d3548;
            --text-primary: #e4e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-purple: #8b5cf6;
            --red: #ef4444;
            --orange: #f59e0b;
            --green: #10b981;
            --yellow: #eab308;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            overflow-x: hidden;
        }
        
        /* Top Navigation Bar */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 56px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .nav-brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        .nav-meta {
            display: flex;
            align-items: center;
            gap: 24px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .nav-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 56px);
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar-section {
            margin-bottom: 24px;
        }
        
        .sidebar-title {
            padding: 0 20px 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        .case-list {
            list-style: none;
        }
        
        .case-item {
            padding: 10px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .case-item:hover {
            background: var(--bg-tertiary);
        }
        
        .case-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-blue);
        }
        
        .case-item-name {
            font-weight: 500;
            font-size: 13px;
        }
        
        .case-item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .mdl-badge {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-badge.settled {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .new-badge {
            background: var(--green);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 6px;
        }
        
        /* Content Area */
        .content-area {
            overflow-y: auto;
            padding: 24px;
        }
        
        /* KPI Cards Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
        }
        
        .kpi-card.death::before { background: var(--red); }
        .kpi-card.injury::before { background: var(--orange); }
        .kpi-card.malfunction::before { background: var(--yellow); }
        
        .kpi-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .kpi-change {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Case Header */
        .case-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .case-header-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .case-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .case-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .case-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .chart-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .chart-control-btn {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chart-control-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .chart-wrapper {
            position: relative;
            height: 320px;
        }
        
        /* Data Table */
        .data-table-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: nowrap;
        }
        
        tbody tr:hover {
            background: var(--bg-tertiary);
        }
        
        .table-number {
            font-weight: 500;
        }
        
        .table-number.death { color: var(--red); }
        .table-number.injury { color: var(--orange); }
        .table-number.malfunction { color: var(--yellow); }
        
        .mdr-count {
            color: var(--accent-cyan);
            cursor: help;
            text-decoration: underline dotted;
            font-size: 12px;
        }
        
        .mdr-count:hover {
            color: var(--accent-blue);
        }
        
        .mdr-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mom-positive {
            color: var(--red);
        }
        
        .mom-negative {
            color: var(--green);
        }
        
        .mom-neutral {
            color: var(--text-muted);
        }
        
        /* Product Tags */
        .products-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .product-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .product-tag {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        /* Footer */
        .footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-links {
            display: flex;
            gap: 16px;
        }
        
        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .footer-link:hover {
            color: var(--accent-blue);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3d4454;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="nav-brand-icon">ML</div>
            <span>MDL Litigation Intelligence</span>
            <span class="new-badge" style="margin-left: 12px;">49 CASES</span>
        </div>
        <div class="nav-meta">
            <div class="nav-meta-item">
                <span class="status-indicator"></span>
                <span>Live Data</span>
            </div>
            <div class="nav-meta-item">
                <span>FDA MAUDE</span>
            </div>
            <div class="nav-meta-item">
                <span id="lastUpdated"></span>
            </div>
        </div>
    </nav>
    
    <!-- Main Layout -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Active MDL Cases</div>
                <ul class="case-list" id="caseList">
                    <!-- Cases will be inserted here -->
                </ul>
            </div>
        </aside>
        
        <!-- Content Area -->
        <main class="content-area">
            <!-- KPI Overview -->
            <div class="kpi-grid" id="kpiGrid">
                <!-- KPIs will be inserted here -->
            </div>
            
            <!-- Case Header -->
            <div class="case-header" id="caseHeader" style="display: none;">
                <div class="case-header-top">
                    <div>
                        <h1 class="case-title" id="caseTitle"></h1>
                        <div class="case-subtitle" id="caseSubtitle"></div>
                    </div>
                    <div class="case-status">
                        <span>●</span>
                        <span>6-Month Pre-Filing Window</span>
                    </div>
                </div>
                <div class="info-grid" id="caseInfoGrid">
                    <!-- Info items will be inserted here -->
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="charts-section" id="chartsSection" style="display: none;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Monthly Adverse Event Trends</h3>
                        <div class="chart-controls">
                            <button class="chart-control-btn">Linear</button>
                            <button class="chart-control-btn">Stacked</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Event Distribution</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Products Section -->
            <div class="products-section" id="productsSection" style="display: none;">
                <div class="chart-header">
                    <h3 class="chart-title">Device Classifications</h3>
                </div>
                <div class="product-tags" id="productTags">
                    <!-- Product tags will be inserted here -->
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="data-table-card" id="dataTableCard" style="display: none;">
                <div class="chart-header">
                    <h3 class="chart-title">Monthly Event Breakdown</h3>
                    <div class="chart-controls">
                        <button class="chart-control-btn">Export CSV</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Deaths</th>
                                <th>MoM %</th>
                                <th>Injuries</th>
                                <th>MoM %</th>
                                <th>Malfunctions</th>
                                <th>MoM %</th>
                                <th>Other</th>
                                <th>Total Events</th>
                                <th>MoM %</th>
                                <th>Death Rate %</th>
                                <th>MDR Report Numbers</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div>
            <span>Data Source: FDA MAUDE Database via OpenFDA API</span>
            <span style="margin: 0 8px;">•</span>
            <span>Last Updated: <span id="footerDate"></span></span>
        </div>
        <div class="footer-links">
            <a href="#" class="footer-link">Documentation</a>
            <a href="#" class="footer-link">API Access</a>
            <a href="#" class="footer-link">Legal Notice</a>
        </div>
    </footer>
    
    <script>
        let casesData = null;
        let monthlyChart = null;
        let pieChart = null;
        
        // Load data
        async function loadData() {
            try {
                const response = await fetch('data/benchmark_cases_data_v49.json');
                casesData = await response.json();
                
                document.getElementById('lastUpdated').textContent = `Updated ${casesData.generated_at}`;
                document.getElementById('footerDate').textContent = casesData.generated_at;
                
                renderKPIs();
                renderCaseList();
                
                // Select first case by default
                if (casesData.cases.length > 0) {
                    selectCase(0);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please ensure benchmark_cases_data_v48.json exists.');
            }
        }
        
        function renderKPIs() {
            const totalDeaths = casesData.cases.reduce((sum, c) => {
                return sum + (c.totals?.death || c.summary?.total_deaths || 0);
            }, 0);
            const totalInjuries = casesData.cases.reduce((sum, c) => {
                return sum + (c.totals?.injury || c.summary?.total_injuries || 0);
            }, 0);
            const totalMalfunctions = casesData.cases.reduce((sum, c) => {
                return sum + (c.totals?.malfunction || c.summary?.total_malfunctions || 0);
            }, 0);
            const totalReports = casesData.cases.reduce((sum, c) => {
                return sum + (c.totals?.total || c.total_mdrs || 0);
            }, 0);
            
            const activeCases = casesData.active_cases || 0;
            const settledCases = casesData.settled_cases || 0;
            
            const html = `
                <div class="kpi-card">
                    <div class="kpi-label">Total MDL Cases</div>
                    <div class="kpi-value">${casesData.total_cases}</div>
                    <div class="kpi-change">${activeCases} Active • ${settledCases} Settled</div>
                </div>
                <div class="kpi-card death">
                    <div class="kpi-label">Total Deaths</div>
                    <div class="kpi-value">${totalDeaths.toLocaleString()}</div>
                    <div class="kpi-change">${((totalDeaths/totalReports)*100).toFixed(2)}% of total events</div>
                </div>
                <div class="kpi-card injury">
                    <div class="kpi-label">Total Injuries</div>
                    <div class="kpi-value">${totalInjuries.toLocaleString()}</div>
                    <div class="kpi-change">${((totalInjuries/totalReports)*100).toFixed(2)}% of total events</div>
                </div>
                <div class="kpi-card malfunction">
                    <div class="kpi-label">Total Malfunctions</div>
                    <div class="kpi-value">${totalMalfunctions.toLocaleString()}</div>
                    <div class="kpi-change">${((totalMalfunctions/totalReports)*100).toFixed(2)}% of total events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total MDRs</div>
                    <div class="kpi-value">${totalReports.toLocaleString()}</div>
                    <div class="kpi-change">6-month pre-filing window</div>
                </div>
            `;
            
            document.getElementById('kpiGrid').innerHTML = html;
        }
        
        function renderCaseList() {
            // MDL numbers for the 20 NEW expansion cases (v49 update - includes FreeStyle Libre)
            const newCaseMDLs = ['2974', '2996', '2775', '2666', '3032', '2928', '2787', '2868', '2768', '2903', '3070', '2428', '2904', '2995', '2881', '2749', '2965', '2848', null];
            // Also mark FreeStyle Libre as new (it has null MDL but is the 49th case)
            const newCaseNames = ['Abbott FreeStyle Libre CGM'];
            
            const html = casesData.cases.map((caseData, index) => {
                const statusBadge = caseData.status === 'Settled' 
                    ? '<span class="status-badge settled">Settled</span>' 
                    : '<span class="status-badge active">Active</span>';
                
                const isNew = newCaseMDLs.includes(caseData.mdl_number) || newCaseNames.includes(caseData.name || caseData.case_name);
                const newBadge = isNew ? '<span class="new-badge">NEW</span>' : '';
                
                const totalMDRs = caseData.totals?.total || caseData.total_mdrs || 0;
                
                return `
                    <li class="case-item ${index === 0 ? 'active' : ''}" onclick="selectCase(${index})">
                        <div class="case-item-name">${caseData.case_name}${newBadge}</div>
                        <div class="case-item-meta">
                            <span class="mdl-badge">MDL ${caseData.mdl_number || 'N/A'}</span>
                            ${statusBadge}
                            <span>${totalMDRs} MDRs</span>
                        </div>
                    </li>
                `;
            }).join('');
            
            document.getElementById('caseList').innerHTML = html;
        }
        
        function selectCase(index) {
            // Update active item in sidebar
            document.querySelectorAll('.case-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            const caseData = casesData.cases[index];
            
            // Show case header
            document.getElementById('caseHeader').style.display = 'block';
            document.getElementById('caseTitle').textContent = caseData.case_name;
            
            // Build subtitle with settlement if applicable
            let subtitle = `MDL No. ${caseData.mdl_number || 'N/A'} • ${caseData.court} • Filed ${caseData.filing_date}`;
            if (caseData.settlement) {
                const settlementAmount = typeof caseData.settlement === 'number' 
                    ? `$${(caseData.settlement / 1e9).toFixed(2)}B` 
                    : caseData.settlement;
                subtitle += ` • Settlement: ${settlementAmount}`;
            }
            document.getElementById('caseSubtitle').textContent = subtitle;
            
            // Get totals - handle both old and new data formats
            const totalMDRs = caseData.totals?.total || caseData.total_mdrs || 0;
            const deaths = caseData.totals?.death || caseData.summary?.total_deaths || 0;
            const injuries = caseData.totals?.injury || caseData.summary?.total_injuries || 0;
            const malfunctions = caseData.totals?.malfunction || caseData.summary?.total_malfunctions || 0;
            
            // Render case info grid
            const deathRate = totalMDRs > 0 ? ((deaths / totalMDRs) * 100).toFixed(2) : '0.00';
            const injuryRate = totalMDRs > 0 ? ((injuries / totalMDRs) * 100).toFixed(2) : '0.00';
            const avgPerMonth = totalMDRs > 0 ? (totalMDRs / 6).toFixed(1) : '0.0';
            
            // Get date range
            const dateRangeStart = caseData.date_range?.start || caseData.summary?.date_range?.split(' to ')[0] || 'N/A';
            const dateRangeEnd = caseData.date_range?.end || caseData.summary?.date_range?.split(' to ')[1] || 'N/A';
            
            const infoHtml = `
                <div class="info-item">
                    <div class="info-label">Data Window</div>
                    <div class="info-value">${dateRangeStart} to ${dateRangeEnd}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total MDRs</div>
                    <div class="info-value">${totalMDRs.toLocaleString()}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Deaths</div>
                    <div class="info-value" style="color: var(--red)">${deaths.toLocaleString()} (${deathRate}%)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Injuries</div>
                    <div class="info-value" style="color: var(--orange)">${injuries.toLocaleString()} (${injuryRate}%)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Malfunctions</div>
                    <div class="info-value" style="color: var(--yellow)">${malfunctions.toLocaleString()}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Avg MDRs/Month</div>
                    <div class="info-value">${avgPerMonth}</div>
                </div>
            `;
            
            document.getElementById('caseInfoGrid').innerHTML = infoHtml;
            
            // Show products
            if (caseData.product_info && caseData.product_info.length > 0) {
                document.getElementById('productsSection').style.display = 'block';
                const tagsHtml = caseData.product_info.map(info => 
                    `<span class="product-tag">${info}</span>`
                ).join('');
                document.getElementById('productTags').innerHTML = tagsHtml;
            } else {
                document.getElementById('productsSection').style.display = 'none';
            }
            
            // Render charts
            renderCharts(caseData);
            
            // Render table
            renderTable(caseData);
            
            // Show sections
            document.getElementById('chartsSection').style.display = 'grid';
            document.getElementById('dataTableCard').style.display = 'block';
        }
        
        function renderCharts(caseData) {
            // Destroy existing charts
            if (monthlyChart) monthlyChart.destroy();
            if (pieChart) pieChart.destroy();
            
            // Chart.js theme
            const chartColors = {
                death: '#ef4444',
                injury: '#f59e0b',
                malfunction: '#eab308',
                gridColor: '#2d3548',
                textColor: '#9ca3af'
            };
            
            Chart.defaults.color = chartColors.textColor;
            Chart.defaults.borderColor = chartColors.gridColor;
            
            // Monthly trends chart
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: caseData.monthly_data.map(m => m.month),
                    datasets: [
                        {
                            label: 'Deaths',
                            data: caseData.monthly_data.map(m => m.death),
                            borderColor: chartColors.death,
                            backgroundColor: chartColors.death + '20',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Injuries',
                            data: caseData.monthly_data.map(m => m.injury),
                            borderColor: chartColors.injury,
                            backgroundColor: chartColors.injury + '20',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Malfunctions',
                            data: caseData.monthly_data.map(m => m.malfunction),
                            borderColor: chartColors.malfunction,
                            backgroundColor: chartColors.malfunction + '20',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11, weight: '500' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1e2738',
                            titleFont: { size: 12, weight: '600' },
                            bodyFont: { size: 11 },
                            padding: 12,
                            borderColor: '#2d3548',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: chartColors.gridColor },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            // Pie chart
            const ctx2 = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Deaths', 'Injuries', 'Malfunctions', 'Other'],
                    datasets: [{
                        data: [
                            caseData.totals.death,
                            caseData.totals.injury,
                            caseData.totals.malfunction,
                            caseData.totals.other
                        ],
                        backgroundColor: [
                            chartColors.death,
                            chartColors.injury,
                            chartColors.malfunction,
                            '#6b7280'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e2738',
                            titleFont: { size: 12, weight: '600' },
                            bodyFont: { size: 11 },
                            padding: 12,
                            borderColor: '#2d3548',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTable(caseData) {
            const html = caseData.monthly_data.map(month => {
                const deathRate = month.total > 0 ? ((month.death / month.total) * 100).toFixed(1) : '0.0';
                
                // Helper function to format MoM change
                const formatMoM = (value) => {
                    if (value === null || value === undefined) {
                        return '<span style="color: var(--text-muted)">-</span>';
                    }
                    const color = value > 0 ? 'var(--red)' : value < 0 ? 'var(--green)' : 'var(--text-muted)';
                    const arrow = value > 0 ? '↑' : value < 0 ? '↓' : '→';
                    return `<span style="color: ${color}">${arrow} ${Math.abs(value).toFixed(1)}%</span>`;
                };
                
                // Format MDR numbers - show count with expandable list
                const mdrNumbers = month.mdr_numbers || [];
                const mdrCount = mdrNumbers.length;
                const mdrDisplay = mdrCount > 0 
                    ? `<span class="mdr-count" title="${mdrNumbers.slice(0, 10).join(', ')}${mdrCount > 10 ? '...' : ''}">${mdrCount} reports</span>`
                    : '<span style="color: var(--text-muted)">-</span>';
                
                return `
                    <tr>
                        <td><strong>${month.month}</strong></td>
                        <td class="table-number death">${month.death}</td>
                        <td class="table-number">${formatMoM(month.mom_death)}</td>
                        <td class="table-number injury">${month.injury}</td>
                        <td class="table-number">${formatMoM(month.mom_injury)}</td>
                        <td class="table-number malfunction">${month.malfunction}</td>
                        <td class="table-number">${formatMoM(month.mom_malfunction)}</td>
                        <td class="table-number">${month.other}</td>
                        <td class="table-number"><strong>${month.total}</strong></td>
                        <td class="table-number">${formatMoM(month.mom_total)}</td>
                        <td class="table-number">${deathRate}%</td>
                        <td class="table-number mdr-cell">${mdrDisplay}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('tableBody').innerHTML = html;
        }
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
